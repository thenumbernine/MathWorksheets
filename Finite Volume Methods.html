<!doctype html>
<html>
	<head>
        <meta charset="utf-8">
		<script type='text/javascript' src='tryToFindMathJax.js'></script>
		<title>Finite Volume Methods</title>
	</head>
	<body>

<h3>Finite Volume Methods</h3>

let $\mu$ span across all coordinates $t,x,y,z$<br>
let $i$ span all states of $U$<br>
$\partial_\mu F^{i\mu} = 0$<br>
separate space and time:<br>
$\partial_t F^{it} + \partial_{x^j} F^{ij} = 0$<br>
let $F^{it} = U^i$<br>
$\partial_t U^i + \partial_{x^j} F^{ij} = 0$<br>
integrate over a volume of spacetime $\Omega$<br>
$\int_\Omega \partial_\mu F^{i\mu} dx^4 = 0$<br>
apply the divergence theorem<br>
$\int_{\partial\Omega} F^{i\mu} n_\mu d\Sigma = 0$<br>
for $n_\mu$ being the spacetime normal<br>
assume the timelike top and bottom are flat (i.e. only vary in spatial dimensions)<br>
such that the lower timelike boundary $\partial\Omega_\tau^-$ (which is spatial) has constant time coordinate $t_1$ and constant normal $n_t = -1$ and $n_i = 0$<br>
and the upper timelike boundary $\partial\Omega_\tau^+$ (which is also spatial) has constant time coordinate $t_2$ and constant normal $n_t = 1$ and $n_i = 0$<br>
$\int_{\partial\Omega_\Sigma} F^{ij} n_j d\sigma + \int_{\partial\Omega_\tau^+} F^{it} (t_2) dx^3 - \int_{\partial\Omega_\tau^-} F^{it} (t_1) dx^3 = 0$<br>
substitute the definition of the timelike flux component $F^{it} = U^i$<br>
$\int_{\partial\Omega_\Sigma} F^{ij} n_j d\sigma + \int_{\partial\Omega_\tau^+} U^i(t_2) dx^3 - \int_{\partial\Omega_\tau^-} U^i(t_1) dx^3 = 0$<br>
assume that the cells never shrink or grow in size, so the timelike top and bottom are equal, i.e. $\partial\Omega_\tau^+ = \partial\Omega_\tau^- = \partial\Omega_\tau$<br>
$\int_{\partial\Omega_\Sigma} F^{ij} n_j d\sigma + \int_{\partial\Omega_\tau} U^i(t_2) dx^3 - \int_{\partial\Omega_\tau} U^i(t_1) dx^3 = 0$<br>
also assume $U^i$ does not vary spatially along the timelike top and bottom surfaces $\partial\Omega_\tau^+$ or $\partial\Omega_\tau^-$<br>
$\int_{\partial\Omega_\Sigma} F^{ij} n_j d\sigma + (U^i(t_2) - U^i(t_1)) \int_{\partial\Omega_\tau}  dx^3 = 0$<br>
$\int_{\partial\Omega_\Sigma} F^{ij} n_j d\sigma + (U^i(t_2) - U^i(t_1)) |\partial\Omega_\tau| = 0$<br>
Let $V$ be the spatial volume of the cell, such that $V = |\partial\Omega_\tau|$<br>
$\int_{\partial\Omega_\Sigma} F^{ij} n_j d\sigma + (U^i(t_2) - U^i(t_1)) V = 0$<br>
$(U^i(t_2) - U^i(t_1)) V = -\int_{\partial\Omega_\Sigma} F^{ij} n_j d\sigma$<br>
Represent the boundary $\Omega_\Sigma$ as the product of the spacelike component $\Omega_\sigma$ and timelike components $\Omega_\Sigma^t$<br>
Note that $\Omega_\Sigma^t$ is just the subset along the reals $[t_1, t_2]$<br>
$(U^i(t_2) - U^i(t_1)) V = -\int_{\partial\Omega_\Sigma^t} \int_{\partial\Omega_\sigma} F^{ij} n_j d\sigma dt$<br>
Assume that the flux $F^{ij}$ is constant with respect to time<br>
$(U^i(t_2) - U^i(t_1)) V = -\int_{\partial\Omega_\Sigma^t} dt \int_{\partial\Omega_\sigma} F^{ij} n_j d\sigma$<br>
Let $\Delta t = t_2 - t_1$<br>
$(U^i(t_2) - U^i(t_1)) V = -\Delta t \int_{\partial\Omega_\sigma} F^{ij} n_j d\sigma$<br>
${{U^i(t_2) - U^i(t_1)}\over{\Delta t}} = -{{\int_{\partial\Omega_\sigma} F^{ij} n_j d\sigma}\over{V}}$<br>
Let $\partial\Omega_\sigma$ be the sum of individual surfaces $\partial\Omega_\sigma^k$ each with normal $n^\sigma_{jk}$ the $k$th surface normal in the direction $x^j$<br> 
Let $F^{ij}$ remain constant along each surface<br>
${{U^i(t_2) - U^i(t_1)}\over{\Delta t}} = -{{ |\partial\Omega_\sigma^k| F^{ij} n^\sigma_{jk} }\over{V}}$<br>
Let $S_k = |\partial\Omega_\sigma^k|$ be the surface area of each spatial boundary portion<br>
${{U^i(t_2) - U^i(t_1)}\over{\Delta t}} = -{{ S_k F^{ij} n^\sigma_{jk} }\over{V}}$<br>
Assume we're using axis-aligned boundaries, and the span along the $i$th dimension is $\Delta x^i$<br>
The spacelike volume of the surface is given by $V = \Pi_{i=1}^n \Delta x^i$<br>
Each $k$th dimension has two surfaces, $S_k^+$ and $S_k^-$, both with area $\Pi_{i=1,i\ne k}^n \Delta x^i$<br>
$S_k^-$ has surface normal $n^{\sigma-}_{jk} = -\delta_{jk}$<br>
$S_k^+$ has surface normal $n^{\sigma+}_{jk} = \delta_{jk}$<br>
Let $x^{\sigma^\pm}$ represent any point on surface $S_k^\pm$, and let the flux $F^{ij}(x^{\sigma^\pm})$ be constant along the surface $S_k^\pm$<br>
${{U^i(t_2) - U^i(t_1)}\over{\Delta t}} = -{{\Pi_{m=1,m\ne k}^n \Delta x^m (F^{ij}(x^{\sigma^+}) \delta_{jk} + F^{ij}(x^{\sigma^-}) (-\delta_{jk})) }\over{\Pi_{m=1}^n \Delta x^m}}$<br>
${{U^i(t_2) - U^i(t_1)}\over{\Delta t}} = -{{\Pi_{m=1,m\ne k}^n \Delta x^m (F^{ik}(x^{\sigma^+}) - F^{ik}(x^{\sigma^-})) }\over{\Pi_{m=1}^n \Delta x^m}}$<br>
${{U^i(t_2) - U^i(t_1)}\over{\Delta t}} = -{{F^{ik}(x^{\sigma^+}) - F^{ik}(x^{\sigma^-}) }\over{\Delta x^k}}$<br>
Solve for $U^i(t_2)$<br>
$U^i(t_2) = U^i(t_1) - {{\Delta t}\over{\Delta x^j}}  (F^{ij}(x^{\sigma^+}) - F^{ij}(x^{\sigma^-}))$<br>
<br>
<br>
<br>

<b>same thing but curved space</b><br>
I'm going to put the $\mu$ as the first index for ease later.<bR>
$\nabla_\mu F^{\mu I} = 0$<br>
assume timelike hypersurfaces are flat for now:<br>
$\partial_t F^{It} + \nabla_j F^{Ij} = 0$<br>
Let $U^I = F^{It}$<br>
$\partial_t U^I + \nabla_j F^{j I} = 0$<br>
Substitute covariant derivative for connection coefficients...<br>
Now we have to consider the tensoral elements of $U^I$<br>
For a $\pmatrix{p \\ q}$ tensor, we get the following:<br>
$\partial_t {U^{i_1 ... i_p}}_{k_1 ... k_q} + \nabla_j {F^{j i_1 ... i_p}}_{k_1 ... k_q} = 0$<br>
Expand the $\nabla_j$, don't assume a coordinate basis, however if you are using a coordinate basis then $e_j = \partial_j$.<br>
$\partial_t {U^{i_1 ... i_p}}_{k_1 ... k_q} 
	+ e_j ({F^{j i_1 ... i_p}}_{k_1 ... k_q})
	+ {\Gamma^j}_{jl} {F^{l i_1 ... i_p}}_{k_1 ... k_q} 
	+ {\Gamma^{i_m}}_{j l} {F^{j i_1 ... i_{m-1} l i_{m+1} ... i_p}}_{k_1 ... k_q} 
	- {\Gamma^l}_{j k_m} {F^{j i_1  ... i_p}}_{k_1 ... k_{m-1} l k_{m+1}... k_q} 
	= 0$<br>
Swap the ${\Gamma^i}_{jk} = {\Gamma^i}_{kj} + {c_{jk}}^i$.  Notice that I'm not assuming a holonomic connection.<br>
$\partial_t {U^{i_1 ... i_p}}_{k_1 ... k_q} 
	+ e_j ({F^{j i_1 ... i_p}}_{k_1 ... k_q})
	+ ({\Gamma^j}_{lj} + {c_{lj}}^j) {F^{l i_1 ... i_p}}_{k_1 ... k_q} 
	+ {\Gamma^{i_m}}_{j l} {F^{j i_1 ... i_{m-1} l i_{m+1} ... i_p}}_{k_1 ... k_q} 
	- {\Gamma^l}_{j k_m} {F^{j i_1  ... i_p}}_{k_1 ... k_{m-1} l k_{m+1}... k_q} 
	= 0$<br>
Substitute ${\Gamma^j}_{ij} = e_i (ln \sqrt{g})$:<br>
Notice that, if you are using a non-coordinate basis with identity metric then this reduces to zero.<br>
$\partial_t {U^{i_1 ... i_p}}_{k_1 ... k_q} 
	+ \frac{\sqrt{g}}{\sqrt{g}} e_j ({F^{j i_1 ... i_p}}_{k_1 ... k_q})
	+ \frac{1}{\sqrt{g}} e_j (\sqrt{g}) {F^{j i_1 ... i_p}}_{k_1 ... k_q} 
	+ {c_{lj}}^j {F^{l i_1 ... i_p}}_{k_1 ... k_q} 
	+ {\Gamma^{i_m}}_{j l} {F^{j i_1 ... i_{m-1} l i_{m+1} ... i_p}}_{k_1 ... k_q} 
	- {\Gamma^l}_{j k_m} {F^{j i_1  ... i_p}}_{k_1 ... k_{m-1} l k_{m+1}... k_q} 
	= 0$<br>
Move the rest of the terms to the source side:<br>
$\partial_t {U^{i_1 ... i_p}}_{k_1 ... k_q} 
	+ \frac{1}{\sqrt{g}} e_j (\sqrt{g} {F^{j i_1 ... i_p}}_{k_1 ... k_q})
	= 
	- {c_{lj}}^j {F^{l i_1 ... i_p}}_{k_1 ... k_q} 
	- {\Gamma^{i_m}}_{j l} {F^{j i_1 ... i_{m-1} l i_{m+1} ... i_p}}_{k_1 ... k_q} 
	+ {\Gamma^l}_{j k_m} {F^{j i_1  ... i_p}}_{k_1 ... k_{m-1} l k_{m+1}... k_q} 
$<br>
Notice that, in order to take advantage of the volume weighting in a non-coordinate basis, you must apply the non-coordinate basis operator and not merely the partial derivative.<br>
Expanding the $e_j$ operator in terms of its linear combination of coordinate basis, denoted $e_\bar{a}$:<br>
$\partial_t {U^{i_1 ... i_p}}_{k_1 ... k_q} 
	+ \frac{1}{\sqrt{g}} {e_j}^\bar{j} e_\bar{j} (\sqrt{g} {F^{j i_1 ... i_p}}_{k_1 ... k_q})
	= 
	- {c_{lj}}^j {F^{l i_1 ... i_p}}_{k_1 ... k_q} 
	- {\Gamma^{i_m}}_{j l} {F^{j i_1 ... i_{m-1} l i_{m+1} ... i_p}}_{k_1 ... k_q} 
	+ {\Gamma^l}_{j k_m} {F^{j i_1  ... i_p}}_{k_1 ... k_{m-1} l k_{m+1}... k_q} 
$<br>
So implementing this as difference operations, what this means is...<br>
(1) For holonomic only: Weight your flux by the coordinate volume at that interface.  Notice that anholonomic, normalized will have a $g = I$ and therefore involve no weight.<br>
(2) Compute your partial derivatives.<br>
(3) For anholonomic only: transform your derivative by the coordinate-to-non-coordinate linear transformation.<br>
(4) For holonomic only: Divide out the weight of the coordinate volume at the center.<br>
...<br>
<br>

<b>try again, keep things in integral form...</b><br>
Following 2019 Trangenstein "Numeric Simulations of Hyperbolic Conservation Laws", section 7.4:<br>
Notice that his book coincides with anholonomic orthonormal basis.<br>
So that's what I'm using here.  $u_1 ... u_n$ are my coordinate chart parameters.  Indexes are in anholonomic non-coordinates.<br>
$\bar{j} =$ the coordinate basis index, ${e_\hat{j}}^j =$ change of basis from non-coordinate to coordinate (non-Cartesian) basis.<br>
$0 = \int_{t_1}^{t_2} 
	\int_{u_{1,L}}^{u_{1,R}}
	...
	\int_{u_{n,L}}^{u_{n,R}}

	\left(
		\frac{\partial}{\partial t}({U^{i_1 ... i_p}}_{k_1 ... k_q})

		+ \frac{1}{V} (
			{e_\bar{j}}^j
			\nabla_j ({F^{j i_1 ... i_p}}_{k_1 ... k_q} V)
		)
	
	\right)

	V

	du_n ... du_1
	dt
$<br>
...for $V = det({e_i}^a)$, the determinant of the derivative of the coordinate basis with the Cartesian basis.<br>
<br>

TODO check this out too:<br>
<a href="https://www.groundai.com/project/fifth-order-finite-volume-weno-in-general-orthogonally-curvilinear-coordinates4982/1">https://www.groundai.com/project/fifth-order-finite-volume-weno-in-general-orthogonally-curvilinear-coordinates4982/1</a><br>
<br>

	</body>
</html>
