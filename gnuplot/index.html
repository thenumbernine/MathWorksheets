<!doctype html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Gnuplot compiled by Emscripten</title>
        <style>
            .emscripten { padding-right: 0; margin-left: auto; font-size: 10px; margin-right: auto; display: block; }
            canvas.emscripten { border: 1px solid black; }
            textarea.emscripten { font-family: monospace; width: 80%; }
            div.emscripten { text-align: center; }
            table.noborder { border: 0; vertical-align: text-top; }
        </style>
    </head>
    <body>
        <h1>Gnuplot 4.6.3 compiled to JS with <a href='https://github.com/kripken/emscripten'>Emscripten</a></h1>
        <p>The API uses a web-worker to start gnuplot, a decent HTML5 browser like firefox (ASM_JS is on) or chrome is required. No feature checks are done here, so nothing happens if your browser 
            is incompatible.
            Feel free to try other scripts from the 
            <a href='http://gnuplot.sourceforge.net/demo_svg_4.6/'>demo page</a>. Remember not to change the output / terminal line, this demo 
            is looking for a file named out.svg generated by gnuplot. Theoretically all browser formats are supported, even animated gif.
            <b>The image is updated as soon as something changes in the script.</b><br>
            The site uses local storage to remember your script in the text area, so when you visit the site again it is still there (your data files are not).<br>
            <br> Author: Christian Huettig, <a href="mailto:chhu79@gmail.com?Subject=Gnuplot%20Site">
                Send Mail</a><br><br>
            <button onclick="localStorage.removeItem('gnuplot.script');
            localStorage.removeItem('gnuplot.files');
            window.location.reload(true)">Reset and delete local storage</button>
        </p>
        <hr/>
        Optional: Grant the program read-access to a specific file on your local computer. This file is _not_ uploaded anywhere. Use it for data files that you want to use in your script.<br>
        <input type="file" id="files" name="files[]" multiple />
        <output id="list"></output>
        <hr/>
        <table class="noborder"><tr><td>
                    <img src="" id="gnuimg" type="image/svg+xml" width=600 height=400 class="float-right"/>
                </td><td valign=top style="width:95%;">
                    <textarea class="emscripten" id="gnuplot" rows="35" onkeyup="scriptChange()">
set terminal svg enhanced size 1000,700
set output 'out.svg'
# set terminal svg size 600,400 dynamic enhanced fname 'arial'  fsize 10 mousing name "heatmaps_3" butt solid 
# set output 'heatmaps.3.svg'
set format cb "%4.1f"
set view 49, 28, 1, 1.48
set samples 70, 70
set isosamples 60, 60
set ticslevel 0
set cbtics border in scale 0,0 mirror norotate  offset character 0, 0, 0 autojustify
set title "4D data (3D Heat Map)\nIndependent value color-mapped onto 3D surface" 
set title  offset character 0, 1, 0 font "" norotate
set xlabel "x" 
set xlabel  offset character 3, 0, 0 font "" textcolor lt -1 norotate
set xrange [ 5.00000 : 35.0000 ] noreverse nowriteback
set ylabel "y" 
set ylabel  offset character -5, 0, 0 font "" textcolor lt -1 rotate by -270
set yrange [ 5.00000 : 35.0000 ] noreverse nowriteback
set zlabel "z" 
set zlabel  offset character 2, 0, 0 font "" textcolor lt -1 norotate
set pm3d implicit at s
set colorbox user
set colorbox vertical origin screen 0.9, 0.2, 0 size screen 0.03, 0.6, 0 front noborder
Z(x,y) = 100. * (sinc(x,y) + 1.5)
sinc(x,y) = sin(sqrt((x-20.)**2+(y-20.)**2))/sqrt((x-20.)**2+(y-20.)**2)
color(x,y) = 10. * (1.1 + sin((x-20.)/5.)*cos((y-20.)/10.))
GPFUN_Z = "Z(x,y) = 100. * (sinc(x,y) + 1.5)"
GPFUN_sinc = "sinc(x,y) = sin(sqrt((x-20.)**2+(y-20.)**2))/sqrt((x-20.)**2+(y-20.)**2)"
GPFUN_color = "color(x,y) = 10. * (1.1 + sin((x-20.)/5.)*cos((y-20.)/10.))"
splot '++' using 1:2:(Z($1,$2)):(color($1,$2)) with pm3d title "4 data columns x/y/z/color"
                    </textarea>
                </td></tr></table>
        <br clear=all>
        <hr>
        <h2 style="float: left;">Output:</h2>
        <textarea class="emscripten" id="output" rows="8">Loading, please wait. </textarea>
        <hr>
        Update 2013-06-23: Re-compiled with latest emscripten. Hidden surface removal bug fixed. Now at <a href="https://github.com/chhu/gnuplot-JS">github</a>.<br>
        Update 2013-05-11: Update to 4.6.3, {} parser bug gone, files work now and remain in your browser storage! No need for repeated upload.<br>
        Update 2012-12-28: Stack reset on re-run, no more out-of-memory. Bug found, no hidden surfaces working atm. Suspecting int64.<br>
        Update 2012-12-29: Using of data files possible, local Storage remembers your script<br>
        Update 2013-01-02: IE10 compatible now. Surprisingly just 10% slower than chrome.<br>
        Update 2013-01-04: UTF8 fix. iOS6 compatible now. Stripped terminals. Enabled gzip compression in webserver, gnuplot.js is 460kb.<br>
        Update 2013-01-06: Fallback to data-uri if Blob is not available, works now in a lot more older/mobile browsers.<br>
        Update 2013-01-11: Proper reset implemented. Consecutive calls do not remember previous states.<br>
        <script src='gnuplot_api.js'></script>
        <script>
                gnuplot = new Gnuplot('gnuplot.js');
                gnuplot.onOutput = function(text) {
                    document.getElementById('output').value += text + '\n';
                    document.getElementById('output').scrollTop = 99999;
                };
                gnuplot.onError = function(text) {
                    document.getElementById('output').value += 'ERR: ' + text + '\n';
                    document.getElementById('output').scrollTop = 99999;
                };
                var lastTAContent = '';
                function scriptChange() {
                    var val = document.getElementById("gnuplot").value;
                    if (lastTAContent == val)
                        return;
                    localStorage["gnuplot.script"] = val;
                    if (gnuplot.isRunning) {
                        setTimeout(scriptChange, 1000);
                    } else {
                        lastTAContent = val;
                        runScript();
                    }
                }
                ;
                files = {};
                if (localStorage["gnuplot.files"])
                    files = JSON.parse(localStorage["gnuplot.files"]);
                for (var key in files)
                    gnuplot.onOutput("Found locally stored file: " + key + " with " + files[key].length + " bytes.");
                var runScript = function() {
                    var editor = document.getElementById('gnuplot');   // textarea
                    var start = Date.now();
                    // "upload" files to worker thread
                    for (var f in files)
                        gnuplot.putFile(f, files[f]);

                    gnuplot.run(editor.value, function(e) {
                        gnuplot.onOutput('Execution took ' + (Date.now() - start) / 1000 + 's.');
                        gnuplot.getFile('out.svg', function(e) {
                            if (!e.content) {
                                gnuplot.onError("Output file out.svg not found!");
                                return;
                            }
                            var img = document.getElementById('gnuimg');
                            try {
                                var ab = new Uint8Array(e.content);
                                var blob = new Blob([ab], {"type": "image\/svg+xml"});
                                window.URL = window.URL || window.webkitURL;
                                img.src = window.URL.createObjectURL(blob);
                            } catch (err) { // in case blob / URL missing, fallback to data-uri
                                if (!window.blobalert) {
                                    alert('Warning - your browser does not support Blob-URLs, using data-uri with a lot more memory and time required. Err: ' + err);
                                    window.blobalert = true;
                                }
                                var rstr = '';
                                for (var i = 0; i < e.content.length; i++)
                                    rstr += String.fromCharCode(e.content[i]);
                                img.src = 'data:image\/svg+xml;base64,' + btoa(rstr);
                            }
                        });
                    });
                };
                // set the script from local storage
                if (localStorage["gnuplot.script"])
                    document.getElementById('gnuplot').value = localStorage["gnuplot.script"];
                scriptChange();
                function handleFileSelect(evt) {
                    var _files = evt.target.files; // FileList object

                    // files is a FileList of File objects. List some properties.
                    var output = [];
                    for (var i = 0, f; f = _files[i]; i++) {
                        output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                                f.size, ' bytes, last modified: ',
                                f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
                                '</li>');
                        (function() {
                            var reader = new FileReader();
                            var fname = f.name;
                            reader.onloadend = function(e) {
                                if (e.target.result) {
                                    gnuplot.onOutput(fname + ": Read success - storing in browser. " + e.target.result.length);
                                    files[fname] = e.target.result;
                                    localStorage["gnuplot.files"] = JSON.stringify(files);
                                }

                            };
                            reader.readAsText(f);
                        })();
                    }
                    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
                }
                document.getElementById('files').addEventListener('change', handleFileSelect, false);

        </script>

    </body>
</html>
